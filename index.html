<!DOCTYPE html>
<html>
<head>
<title> Micro Diary â€” Undo/Redo Fix</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    max-width: 700px; 
    margin: 30px auto; 
    padding: 20px; 
    background: linear-gradient(to bottom, #f9f7f7, #dbe2ef);
  }
  h2 { text-align: center; color: #112d4e; margin-bottom: 12px; }
  textarea { 
    width: 100%; 
    height: 300px; 
    padding: 12px; 
    border: 2px solid #3f72af; 
    border-radius: 10px; 
    resize: none; 
    font-size: 15px;
    outline: none;
    box-sizing: border-box;
  }
  .controls { margin-top: 10px; display:flex; gap:8px; flex-wrap:wrap; }
  .btn {
    padding: 10px 18px; 
    border: none; 
    border-radius: 8px; 
    color: white; 
    cursor: pointer; 
    font-weight: 700;
    transition: transform .12s ease, opacity .12s ease;
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
  }
  .btn:hover:enabled { transform: translateY(-2px); opacity: 0.95; }
  .undo { background: linear-gradient(90deg,#f08a5d,#ffb997); }
  .redo { background: linear-gradient(90deg,#6a2c70,#b983d6); }
  .save { background: linear-gradient(90deg,#3fc1c9,#0abf8f); }
  .btn:disabled { opacity: 0.5; transform: none; cursor: not-allowed; }
  .entry { 
    background: linear-gradient(90deg,#fff7f0,#fff0f6); 
    padding: 10px; 
    margin: 8px 0; 
    border-left: 6px solid #f08a5d; 
    border-radius: 6px;
    word-break: break-word;
  }
  #history { max-height: 220px; overflow-y: auto; margin-top: 16px; padding-right:6px; }
  small.hint { color:#3f72af; display:block; margin-top:6px; }
</style>
</head>
<body>
<h2>ðŸ“” My Micro Diary</h2>

<textarea id="entry" placeholder="Write about your day... (max 30 lines)"></textarea>

<div class="controls">
  <button class="btn undo" id="undoBtn" title="Undo (Ctrl/Cmd+Z)">â®Œ Undo</button>
  <button class="btn redo" id="redoBtn" title="Redo (Ctrl/Cmd+Y or Ctrl/Cmd+Shift+Z)">â®Ž Redo</button>
  <button class="btn save" id="saveBtn" title="Save entry">ðŸ’¾ Save</button>
</div>
<small class="hint">Tip: use <strong>Ctrl/Cmd + Z</strong> for Undo, <strong>Ctrl/Cmd + Y</strong> or <strong>Ctrl/Cmd + Shift + Z</strong> for Redo.</small>

<h3 style="color:#112d4e; margin-top:18px;">Past Entries</h3>
<div id="history"></div>

<script>
const entryBox = document.getElementById('entry');
const undoBtn = document.getElementById('undoBtn');
const redoBtn = document.getElementById('redoBtn');
const saveBtn = document.getElementById('saveBtn');
const historyView = document.getElementById('history');

let historyStack = []; // stores previous states
let redoStack = [];    // stores undone states
let lastValue = entryBox.value; // holds the most recent value we consider "current"
const MAX_HISTORY = 300; // to avoid memory blow-up

// When user types, push the previous value (lastValue) so undo goes back
entryBox.addEventListener('input', () => {
  historyStack.push(lastValue);
  if (historyStack.length > MAX_HISTORY) historyStack.shift();
  lastValue = entryBox.value;
  redoStack = [];
  updateButtons();
});

// Undo action
undoBtn.addEventListener('click', () => {
  if (historyStack.length === 0) return;
  redoStack.push(lastValue);
  lastValue = historyStack.pop();
  entryBox.value = lastValue;
  updateButtons();
});

// Redo action
redoBtn.addEventListener('click', () => {
  if (redoStack.length === 0) return;
  historyStack.push(lastValue);
  lastValue = redoStack.pop();
  entryBox.value = lastValue;
  updateButtons();
});

// Keyboard shortcuts for Undo/Redo
document.addEventListener('keydown', (e) => {
  const mod = e.ctrlKey || e.metaKey;
  if (!mod) return;
  // Ctrl/Cmd + Z
  if (e.key === 'z' || e.key === 'Z') {
    e.preventDefault();
    // If Shift is held, treat as Redo (Ctrl+Shift+Z)
    if (e.shiftKey) { redoBtn.click(); }
    else { undoBtn.click(); }
  }
  // Ctrl/Cmd + Y -> Redo
  if (e.key === 'y' || e.key === 'Y') {
    e.preventDefault();
    redoBtn.click();
  }
});

// Save entry
saveBtn.addEventListener('click', saveEntry);

function saveEntry(){
  const text = entryBox.value.trim();
  if (text === "") {
    alert("Cannot save an empty entry!");
    return;
  }
  if (text.split("\n").length > 30){
    alert("Max 30 lines allowed!");
    return;
  }
  const today = new Date().toLocaleDateString();
  const all = JSON.parse(localStorage.getItem('diary') || '[]');
  all.unshift({ date: today, content: text });
  localStorage.setItem('diary', JSON.stringify(all));
  showEntries();
  // clear writer and reset undo/redo stacks
  entryBox.value = "";
  lastValue = entryBox.value;
  historyStack = [];
  redoStack = [];
  updateButtons();
}

// Render saved entries
function showEntries(){
  const all = JSON.parse(localStorage.getItem('diary') || '[]');
  historyView.innerHTML = all.map(e =>
    `<div class="entry"><strong>${escapeHtml(e.date)}</strong><br>${escapeHtml(e.content).replace(/\n/g,'<br>')}</div>`
  ).join('');
}

// helper to disable/enable buttons
function updateButtons(){
  undoBtn.disabled = historyStack.length === 0;
  redoBtn.disabled = redoStack.length === 0;
}

// simple escape to avoid accidental HTML injection in entries
function escapeHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// initialize
updateButtons();
showEntries();
</script>
</body>
</html>